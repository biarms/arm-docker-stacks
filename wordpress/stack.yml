version: '3.4'

services:
  wordpress-db:
    image: ${DOCKER_REGISTRY}biarms/mysql:5.5 #5.5 is for backward compatibility with RPI1 (arm32v6). 5.7 is maybe better for RPI2 or RPI3 (arm32v7)
    volumes:
      - db-data:/var/lib/mysql
    ports:
      - 3306
    environment:
      MYSQL_ROOT_PASSWORD_FILE: /run/secrets/db-root-password
      MYSQL_DATABASE: wordpress
      MYSQL_USER: wordpress
      MYSQL_PASSWORD_FILE: /run/secrets/db-password
    secrets:
      - db-root-password
      - db-password
    deploy:
      replicas: 1
    mem_reservation: 256m
    mem_limit: 512m

  wordpress:
    image: biarms/wordpress:5.4.0
    volumes:
      - htdocs:/var/www/html
    ports:
      - 80
    environment:
      WORDPRESS_DB_HOST: wordpress-db:3306
      WORDPRESS_DB_USER: wordpress
      WORDPRESS_DB_PASSWORD_FILE: /run/secrets/db-password
      WORDPRESS_DB_NAME: wordpress
    secrets:
      - db-password
    deploy:
      replicas: 1
    mem_reservation: 96m #64m
    mem_limit: 192m #128m

  wordpress-phpmyadmin:
    image: ${DOCKER_REGISTRY}biarms/phpmyadmin:4.8.3
    ports:
      - 80
    environment:
      - PMA_HOST=wordpress-db
      - PMA_PORT=3306
    deploy:
      replicas: 0
    mem_reservation: 32m
    mem_limit: 64m
   # https://hub.docker.com/r/arm32v6/adminer/

volumes:
  db-data:
  htdocs:

# Inspired by https://docs.docker.com/engine/swarm/secrets/#use-secrets-in-compose
secrets:
  db-password:
    file: db-password.txt
  db-root-password:
    file: db-root-password.txt

# Next steps: create a cluster (see https://severalnines.com/blog/mysql-docker-introduction-docker-swarm-mode-and-multi-host-networking)
